name: List Disabled Workflows

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      workingOrgs:
        description: 'Comma-separated orgs to scan'
        default: 'nntthuy-axonivy'

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: List disabled workflows
        env:
          GH_TOKEN: ${{ github.token }}
          ORG: ${{ github.event.inputs.workingOrgs }}
        run: |
          echo "Scanning org: $ORG"
          echo "------------------------------------"

          page=1
          while true; do
            repos=$(curl -s \
              -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$ORG/repos?per_page=100&page=$page")

            [ "$(echo "$repos" | jq length)" -eq 0 ] && break

            echo "$repos" | jq -r '.[].name' | while read repo; do
              workflows=$(curl -s \
                -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$repo/actions/workflows")

              disabled=$(echo "$workflows" | jq -r '.workflows[] | select(.state=="disabled_inactivity") | .name')

              if [ -n "$disabled" ]; then
                echo ""
                echo "Repo: $repo"
                echo "$disabled" | sed 's/^/  - /'
              fi
            done

            page=$((page + 1))
          done
