name: Re-enable Disabled Workflows

permissions:
  contents: read
  actions: write
on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      workingOrg:
        description: 'Organization to scan'
        default: 'axonivy-market'

jobs:
  re-enable:
    runs-on: ubuntu-latest

    steps:
      - name: Re-enable disabled workflows
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ORG="${{ github.event.inputs.workingOrg }}"
          echo "Scanning org: $ORG"
          echo "------------------------------------"

          # Get all non-archived repos in org
          gh repo list "$ORG" --limit 1000 --json name,isArchived -q '.[] | select(.isArchived==false) | .name' |
          while read repo; do
            echo "Checking repo: $repo"
            workflows=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$ORG/$repo/actions/workflows")

            # Skip repos without workflow access
            if ! echo "$workflows" | jq -e '.workflows' >/dev/null 2>&1; then
              echo "  Skipped (no workflow access)"
              continue
            fi

            # Enable disabled workflows due to inactivity
            echo "$workflows" | jq -r '.workflows[]? | select(.state=="disabled_manually") | "\(.id)|\(.name)"' | 
            while IFS="|" read id name; do
              echo "  â†’ Enabling workflow: $name (ID: $id)"
              curl -s -X PUT -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$ORG/$repo/actions/workflows/$id/enable">/dev/null
            done
          done
